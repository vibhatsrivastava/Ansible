---
- name: Get SQL server configuration Info
  ansible.windows.win_shell: |
    $SQL_Server_Config_Validation_Report = [System.Collections.ArrayList]@()
    $SQL_Instance_Info = Get-SqlInstance -ServerInstance "{{ SQL_Server_Name }}"
    
    $Replication_Info = [System.Collections.ArrayList]@()
    $All_SQL_Database = Get-SqlDatabase -ServerInstance "{{ SQL_Server_Instance }}"
    foreach($db in $All_SQL_Database.Name)
    { 
      $db_replication_info = Invoke-Sqlcmd -TrustServerCertificate -Query "SELECT SERVERPROPERTY('IsReplicationInstalled') AS ReplicationInstalled;" -ServerInstance "{{ SQL_Server_Instance }}" -Database $db
      $Replication_Info += "$db Replication Info : `r`n$($db_replication_info.ReplicationInstalled | out-string)"
    }
    
    $sql_max_text_repl_size_info = Invoke-Sqlcmd -TrustServerCertificate -Query "EXEC sp_configure 'max text repl size';" -ServerInstance "{{ SQL_Server_Instance }}"

    $IsFullTextInstalled = Invoke-Sqlcmd -TrustServerCertificate -Query "SELECT SERVERPROPERTY('IsFullTextInstalled') AS FullTextSearchInstalled;" -ServerInstance "{{ SQL_Server_Instance }}"
    if($IsFullTextInstalled.FullTextSearchInstalled -eq 0 ) { $IsFullTextInstalled_Info = "IsFullTextInstalled: $False" } else { $IsFullTextInstalled_Info = "IsFullTextInstalled: $True" }

    $Filestream_status = Invoke-Sqlcmd -TrustServerCertificate -Query "SELECT value_in_use FROM sys.configurations WHERE name = 'filestream access level';" -ServerInstance "{{ SQL_Server_Instance }}"
    if($Filestream_status.value_in_use -eq 0) { $Filestream_Info = "Filestream_Info: Disabled" }
    elseif($Filestream_status.value_in_use -eq 1) { $Filestream_Info = "Filestream_Info: T-SQL access only" }
    elseif($Filestream_status.value_in_use -eq 2) { $Filestream_Info =  "Filestream_Info: T-SQL and Win32 streaming access" }
    else { $Filestream_Info =  "Filestream_Info: Incorrect / Garbage value obtained" }

    $SQLServer_Service_StartType = (get-service MSSQLSERVER).StartType
    $SQLServer_Service_StartType_Info = "SQL Server Service Startup Type: $SQLServer_Service_StartType"

    $SQL_Server_Config_Validation_Report += $SQL_Instance_Info
    $SQL_Server_Config_Validation_Report += $Replication_Info
    $SQL_Server_Config_Validation_Report += $IsFullTextInstalled_Info
    $SQL_Server_Config_Validation_Report += $Filestream_info
    $SQL_Server_Config_Validation_Report += $SQLServer_Service_StartType_Info

    Write-Output $SQL_Server_Config_Validation_Report | Out-File "{{ report_dir}}\\{{ report_filename }}" -Force